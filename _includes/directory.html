<section class="navigation">
{% capture folder_directory %}
{% assign folders = "" | split: ',' %}
{% for page in site.html_pages %}
{% unless page.exclude %}
{% unless page.name == 'index.html' or page.name == 'index.md' %}
{% comment %}
    Get first folder only
    e.g. /, /folder1/, 
{% endcomment %}
{% assign escaped_dir = page.dir | uri_escape | remove_first: '/' | split: '/' | first | prepend: '/' %}
{% if escaped_dir != '/' %}
{% assign escaped_dir = escaped_dir | append: '/' %}
{% endif %}

{% assign folders = folders | push: escaped_dir %}
{% endunless %}
{% endunless %}
{% endfor %}
{% assign folders = folders | uniq | sort %}

{% comment %}
    Show table of directories only in root path
{% endcomment %}
{% if include.currdir != blank or include.currdir == '/' %}
<ul class="table-of-directories">
{% else %}
<ul class="table-of-directories hidden">
{% endif %}


{% comment %}
    if document_order is listed, sort according to document_order
{% endcomment %}
{% if site.document_order %}
    {% assign sorted_folders = '' | split: '' %}
    {% for document in site.document_order %}
        {% assign document_to_compare = document | strip | uri_escape | downcase %}
        {% for folder in folders %}
            {% assign folder_to_compare = folder | remove: '/' | downcase %}
            {% if document_to_compare == folder_to_compare %}
                {% assign sorted_folders = sorted_folders | push: folder %}
            {% endif %}
        {% endfor %}
    {% endfor %}
{% else %}
{% assign sorted_folders = folders %}
{% endif %}

{% for folder in sorted_folders %}
<li>
<a href="{{ folder | relative_url }}" id="dir_{{ folder | downcase }}" class="tod-container">
<div class="directory-item">
{% include_cached document-title.txt dir=folder info="title" %}
</div></a>
</li>
{% endfor %}

</ul>
{% endcapture %}

{% comment %}
If there is only one folder or documents all at root, dont show back button
{% endcomment %}
{% if sorted_folders.size > 1 %}
{{ folder_directory | markdownify | strip }}
<div class="back-to-documents">
    <p>Back to Documents <img class="btn-icon" src="{{ '/assets/images/chevron-up.svg' | relative_url }}"></p>
</div>
{% endif %}

{% for folder in sorted_folders %}
{% comment %}
    Similarly, get only first subfolder of the currdir being passed in 
{% endcomment %}
{% assign include_currdir_decode = include.currdir | remove_first: '/' | split: '/' | first | uri_escape | prepend: '/' %}
{% if include_currdir_decode != '/' %}
{% assign include_currdir_decode = include_currdir_decode | append: '/' %}
{% endif %}
{% comment %}
If there is only one folder, show expanded content list
{% endcomment %}
{% assign toc_id = 'toc_' | append: folder | downcase %}
{% if sorted_folders.size == 1 %}
<section class="contents lonely" id="{{ toc_id }}">
{% elsif include_currdir_decode == folder and include.currdir != '/' %}
<section class="contents" id="{{ toc_id }}">
{% else %}
<section class="contents" id="{{ toc_id }}" hidden>
{% endif %}    
{% include_cached toc.html path=folder class="table-of-contents" h_min=1 h_max=2 item_class="nav-branch" anchor_class="nav-link" %}
</section>

{% endfor %}
</section>
